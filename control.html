<DOCTYPE html>
<html>

<head>
  <title>Control VOLNA2.0</title>
  <link rel="stylesheet" type="text/css" href="control.css">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="144x144" href="favicon-144x144.png">
  <link rel="icon" type="image/png" sizes="48x48" href="favicon.ico">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#001b4c">
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
</head>

<body>
	<ul>
<li><a href="./index.html">Главная</a></li>
  <li><a class="active" href="./control.html">Управление независимыми контурами</a></li>
  <li><a href="./hw.html">ГВС</a></li>
  <li><a href="./hand.html">Сервисное меню</a></li>
</ul>
  <section class="control">
  	<div class="block">
  		<header class="header">
  		<input type="text" class="title_name" name="name" id="name1" value="T1" maxlength="15" tabindex="-1" oninput="changed_name()" />
  		</header>
  		<div class="main_control">
  		 <div class="simple">Температура t1:<span id="t1c">0</span> <sup>o</sup>C</div><br>
  		 <input type="number" step="1" min="0" max="50" value="25" id="input1" name="points" tabindex="1" onwheel="MoveEdit(this,event)" onkeyup="isright(this)" onclick="this.select()" oninput="changed_inp(this)">
  		 </div>
  		 <div class="slider">
    		<input type="range" id="slider1" class="slider_vertical" min="0" max="50" tabindex="-1" oninput="changed_slider(this)" />
  		</div>
      <div class="status">
        Статус насоса: <span id="vlv1"> [..]</span>
      </div>
  		 
  	</div>
  	  	<div class="block">
  		<header class="header">
  		<input type="text" class="title_name" name="name" id="name2" value="T2" maxlength="15" tabindex="-1" oninput="changed_name()"/>
  		</header>
  		<div class="main_control">
  		 <div class="simple">Температура t2:<span id="t2c">0</span> <sup>o</sup>C</div><br>
  		 <input type="number" step="1" min="0" max="50" value="25" id="input2" name="points" tabindex="2" onwheel="MoveEdit(this,event)" onkeyup="isright(this)" onclick="this.select()" oninput="changed_inp(this)">
  		 </div>
  		 <div class="slider">
    		<input type="range" id="slider2" class="slider_vertical" min="0" max="50" tabindex="-1" oninput="changed_slider(this)" />
  		</div>
      <div class="status">
        Статус насоса: <span id="vlv2"> [..]</span>
      </div>
  		 
  	</div>
  	  	<div class="block">
  		<header class="header">
      <input type="text" class="title_name" name="name" id="name3" value="T3" maxlength="15" tabindex="-1" oninput="changed_name()"/>
      </header>
  		<div class="main_control">
  		 <div class="simple">Температура t3:<span id="t3c">0</span> <sup>o</sup>C</div><br>
  		 <input type="number" step="1" min="0" max="50" value="25" id="input3" name="points" tabindex="3" onwheel="MoveEdit(this,event)" onkeyup="isright(this)" onclick="this.select()" oninput="changed_inp(this)">
  		</div>
  		 <div class="slider">
    		<input type="range" id="slider3" class="slider_vertical" min="0" max="50" tabindex="-1" oninput="changed_slider(this)" />
  		</div>
      <div class="status">
        Статус насоса: <span id="vlv3"> [..]</span>
      </div>
  		 
  	</div>
  </section>

  <section class="control">
    <div class="block">
      <header class="header">
      <input type="text" class="title_name" name="name" id="name4" value="T4" maxlength="15" tabindex="-1" oninput="changed_name()"/>
      </header>
      <div class="main_control">
       <div class="simple">Температура t4:<span id="t4c">0</span> <sup>o</sup>C</div><br>
       <input type="number" step="1" min="0" max="50" value="25" id="input4" name="points" tabindex="4" onwheel="MoveEdit(this,event)" onkeyup="isright(this)" onclick="this.select()" oninput="changed_inp(this)">
       </div>
       <div class="slider">
        <input type="range" id="slider4" class="slider_vertical" min="0" max="50" tabindex="-1" oninput="changed_slider(this)" />
      </div>
      <div class="status">
        Статус насоса: <span id="vlv4"> [..]</span>
      </div>
       
    </div>
        <div class="block">
      <header class="header">
      <input type="text" class="title_name" name="name" id="name5" value="T5" maxlength="15" tabindex="-1" oninput="changed_name()"/>
      </header>
      <div class="main_control">
       <div class="simple">Температура t5:<span id="t5c">0</span> <sup>o</sup>C</div><br>
       <input type="number" step="1" min="0" max="50" value="25" id="input5" name="points" tabindex="5" onwheel="MoveEdit(this,event)" onkeyup="isright(this)" onclick="this.select()" oninput="changed_inp(this)">
       </div>
       <div class="slider">
        <input type="range" id="slider5" class="slider_vertical" min="0" max="50" tabindex="-1" oninput="changed_slider(this)" />
      </div>
      <div class="status">
        Статус насоса: <span id="vlv5"> [..]</span>
      </div>
       
    </div>
        <div class="block">
      <header class="header">
      <input type="text" class="title_name" name="name" id="name6" value="T6" maxlength="15" tabindex="-1" oninput="changed_name()"/>
      </header>
      <div class="main_control">
       <div class="simple">Температура t6:<span id="t6c">0</span> <sup>o</sup>C</div><br>
       <input type="number" step="1" min="0" max="50" value="25" id="input6" name="points" tabindex="6" onwheel="MoveEdit(this,event)" onkeyup="isright(this)" onclick="this.select()" oninput="changed_inp(this)">
      </div>
       <div class="slider">
        <input type="range" id="slider6" class="slider_vertical" min="0" max="50" tabindex="-1" oninput="changed_slider(this)" />
      </div>
      <div class="status">
        Статус насоса: <span id="vlv6"> [..]</span>
      </div>
       
    </div>
  </section>
<!--------------------------------------------------------------------------------------------------------------------------------->

<section class="control">
  <div class="floor_block">
    <h3>Отправка команды на сервер:</h3>
    <input type="text" class="inp_console" id="commandSendText" name="Команда:" value="&" tabindex="-1">
    <button id="commandSendBtn" class="button" onclick="commandSend();" tabindex="-1">Отправить</button>
    <div style="padding: 10px">Качество сотовой сети <span id="sQual"></span>%</div>
  </div>
  <div class="floor_block">
    <h3>Управление</h3><h4 style="color: white" id="response_string" ></h4>
    <button id="Save_Btn" class="button" onclick="Save_Sett();" tabindex="7">Сохранить</button>
</section>


  <script>
    var ejson;
    var connection = new WebSocket('ws://' + location.hostname + ':81/', ['arduino']);
      connection.onopen = function () {
        connection.send('Connect ' + new Date());
      };
      connection.onerror = function (error) {
        console.log('WebSocket Error ', error);
      };
      connection.onmessage = function (e) {
        console.log('Server: ', e.data);
        ejson = JSON.parse(e.data);

        vl.getElementById("t1c").innerHTML = ejson.t1c;
        vl.getElementById("t2c").innerHTML = ejson.t2c;
        vl.getElementById("t3c").innerHTML = ejson.t3c;
        vl.getElementById("t4c").innerHTML = ejson.t4c;
        vl.getElementById("t5c").innerHTML = ejson.t5c;
        vl.getElementById("t6c").innerHTML = ejson.t6c;
        vl.getElementById("vlv1").innerHTML = onoff(ejson.vlv1);
        vl.getElementById("vlv2").innerHTML = onoff(ejson.vlv2);
        vl.getElementById("vlv3").innerHTML = onoff(ejson.vlv3);
        vl.getElementById("vlv4").innerHTML = onoff(ejson.vlv4);
        vl.getElementById("vlv5").innerHTML = onoff(ejson.vlv5);
        vl.getElementById("vlv6").innerHTML = onoff(ejson.vlv6);
        vl.getElementById("vlv1").style.color = setColor(ejson.vlv1);
        vl.getElementById("vlv2").style.color = setColor(ejson.vlv2);
        vl.getElementById("vlv3").style.color = setColor(ejson.vlv3);
        vl.getElementById("vlv4").style.color = setColor(ejson.vlv4);
        vl.getElementById("vlv5").style.color = setColor(ejson.vlv5);
        vl.getElementById("vlv6").style.color = setColor(ejson.vlv6);
        if(ejson.sQual < 33) {vl.getElementById("sQual").innerHTML = ejson.sQual/32*100;}
      };
      connection.onclose = function () {
        console.log('WebSocket connection closed');
      };

    var rSettings;
    var names;
    var vl = document;
    vl.onload = hel();
    
// Базовая функция при старте
    function hel() {

      var requestURL = '/settings.json';
      var request = new XMLHttpRequest();
      request.open('GET', requestURL);
      request.responseType = 'json';
      request.send();
      request.onload = function () {
        rSettings = request.response;
        for (var i = 1; i < 7; i++) {
        	vl.getElementById("input"+i).value = rSettings.tempset[i+7];
        	vl.getElementById("slider"+i).value = rSettings.tempset[i+7];
        	     }
      }
      /////////////////Names get//////////////////
      requestURL = '/names.json';
      var request2 = new XMLHttpRequest();
      request2.open('GET', requestURL);
      request2.responseType = 'json';
      request2.send();
      request2.onload = function () {
      	names = request2.response;
      	for (var i = 1; i < 7; i++) {
      		vl.getElementById("name"+i).value = names.nameControl[i-1];
      	}
      }      
    }



// Функция отправки команд к контроллеру
    function commandSend() {
      var localText;
      localText = vl.getElementById("commandSendText").value;
      connection.send(localText);
      console.log(localText);
    }
    function anyCommandSend(tText) {
      connection.send(tText);
      console.log(tText);
    }

// Функция красивого отображения вкл/выкл
    function onoff(valueonoff) {
      var retText = "";
      if (valueonoff == 0) {
        retText = " [ВЫКЛ]";
      } else {
        retText = " [ВКЛ]";
      }
      return retText;
    }

    function setColor(valueColor) {
      var retColor = "";
      if (valueColor == 0) {retColor = "#b31919";}
      else {retColor = "#0fbd3b";}
      return retColor;
    }

// Функция смены режима
    function hModeSwitch() {
      if (ejson.hMode == 0) {
        connection.send("&hMode=1");
        console.log("&hMode=1");
      } else {
        connection.send("&hMode=0");
        console.log("&hMode=0");
      }
    }


////////////////////////////Scroll Func//////////////////////////////////////////////
 var scroll=-2;

function MoveEdit(obj,event)
	{
    var delta = event.deltaY;
    if(obj.value>-51 && obj.value<126)
    	if(scroll>=0 && scroll<=1){
    		scroll = +scroll + delta/100;
    	}
    	else{
    		scroll=0;
    		obj.value= +obj.value+1;
    		document.getElementById("slider"+obj.id.slice(-1)).value=obj.value;
    		vl.getElementById("response_string").innerHTML = "Настройки изменены";
    	}
    	////////////////////////////////////////////////
    	    	if(scroll>=-1 && scroll<=0){
    		scroll = +scroll + delta/100;
    	}
    	else{
    		scroll=0;
    		obj.value= +obj.value-1;
    		document.getElementById("slider"+obj.id.slice(-1)).value=obj.value;
    		vl.getElementById("response_string").innerHTML = "Настройки изменены";
    	}
    	if(scroll==-2){scroll=0; obj.value= +obj.value+1; document.getElementById("slider"+obj.id.slice(-1)).value=obj.value;} //я хз как это работает, но оно работает, 3 часа потрачены не зря
    //////////////////////////////////////////////////
    if(obj.value<-50) obj.value =-50;
    if(obj.value>125) obj.value =125;
    if (event.preventDefault) event.preventDefault();
    event.returnValue = false;
	} 
	/////////////////////////////////////////////////////////////////////
	function isright(obj)
{
  if(obj.value<-50) obj.value =-50;
  if(obj.value>125) obj.value =125;
}
	///////////////////Changed Functions//////////////////////////////////////////
	function changed_inp(obj){
		document.getElementById("slider"+obj.id.slice(-1)).value=obj.value;
		vl.getElementById("response_string").innerHTML = "Настройки изменены";
	}

	function changed_slider(obj){
		document.getElementById("input"+obj.id.slice(-1)).value=obj.value;
		vl.getElementById("response_string").innerHTML = "Настройки изменены";
	}

	function changed_name(){
		vl.getElementById("response_string").innerHTML = "Настройки изменены";
	}
//////////////////////////////////////////End of Scroll Func////////////////////////////////////////////////////////////

////////////////////////////////////////Save Settings////////////////////////////

	function Save_Sett(){
		for (var i = 1; i < 7; i++) {
        	rSettings.tempset[i+7] = Number(vl.getElementById("input"+i).value);
        	names.nameControl[i-1] = vl.getElementById("name"+i).value;
        	     }
		var strJ = rSettings;
		var strN = JSON.stringify(names);
      	var strD = JSON.stringify(strJ);
      	var fnData = new FormData();
      	var fData = new FormData();
      	var myBlob2 = new Blob([strN],{ type: "plain/text"});
      	var myBlob = new Blob([strD], {
        	type: "plain/text"
      	});
      	fnData.append("file", myBlob2, "names.json");
      	fData.append("file", myBlob, "settings.json");
      	var oReq = new XMLHttpRequest();
      	var oReqN = new XMLHttpRequest();
      	oReq.open("POST", "/edit.html", true);
      	oReq.onreadystatechange = function () {
      	if(oReq.readyState === 4 && oReq.status === 200) {
      	vl.getElementById("response_string").innerHTML= "Настройки сохранены";
  				}
		}
      	oReq.send(fData);
      	////Names Send//////
      	oReqN.open("POST", "/edit.html", true);
      	oReqN.send(fnData);

	}
  </script>
</body>

</html>
