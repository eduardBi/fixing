<!DOCTYPE html>
<html>

<head>
  <title>Control VOLNA2.0</title>
  <link rel="stylesheet" type="text/css" href="main.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="144x144" href="/favicon-144x144.png">
  <link rel="icon" type="image/png" sizes="48x48" href="/favicon.ico">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#001b4c">
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
</head>

<body>
	<ul>
  <li><a href="./index.html">Главная</a></li>
  <li><a href="./control.html">Управление независимыми контурами</a></li>
  <li><a href="./hw.html">ГВС</a></li>
  <li><a class="active" href="./hand.html">Сервисное меню</a></li>
  <li><a href="./edit.html">Обновление файлов</a></li>
  <li><a href="./update">Обновление прошивки</a></li>
  <li><a href="./settings.json">Основные параметры</a></li>
  <li><a href="./wifi.html">WIFI параметры</a></li>
</ul>

  <section class="flex-container">
    <section>
      <header>
        <h1>Сервисное меню ЭСКО VOLNA2.0</h1>
      </header>
      <footer id="bttns">

<div class="wrapper">
		<div class="left_block"><input type="text" id="commandSendText" name="Команда:" value="&" style="height:60%; width:80%; border-radius:5px"></div>
		<div class="right_block"><button id="commandSendBtn" class="button" onclick="commandSend();" style="margin:3px">Отправить</button></div>
</div>

<div class="menu">Ручной режим временный</div>
    <div class="main">
		<label class="switch">
		<input id="hmchb" type="checkbox" onclick="hModeSwitch();">
		<span class="slider round"></span>
		</label>
	</div>
<div class="right"></div>
<div class="menu">Канал 1</div>
    <div class="main">
		<label class="switch">
		<input id="k1chb" type="checkbox" onclick="vlSwitch(1);">
		<span class="slider round"></span>
		</label>
	</div>
<div class="right"><span id="t1c">0</span> <sup>o</sup>C</div>
<div class="menu">Канал 2</div>
    <div class="main">
		<label class="switch">
		<input id="k2chb" type="checkbox" onclick="vlSwitch(2);">
		<span class="slider round"></span>
		</label>
	</div>
<div class="right"><span id="t2c">0</span> <sup>o</sup>C</div>
<div class="menu">Канал 3</div>
    <div class="main">
		<label class="switch">
		<input id="k3chb" type="checkbox" onclick="vlSwitch(3);">
		<span class="slider round"></span>
		</label>
	</div>
<div class="right"><span id="t3c">0</span> <sup>o</sup>C</div>
<div class="menu">Канал 4</div>
    <div class="main">
		<label class="switch">
		<input id="k4chb" type="checkbox" onclick="vlSwitch(4);">
		<span class="slider round"></span>
		</label>
	</div>
<div class="right"><span id="t4c">0</span> <sup>o</sup>C</div>
<div class="menu">Канал 5</div>
    <div class="main">
		<label class="switch">
		<input id="k5chb" type="checkbox" onclick="vlSwitch(5);">
		<span class="slider round"></span>
		</label>
	</div>
<div class="right"><span id="t5c">0</span> <sup>o</sup>C</div>
<div class="menu">Канал 6</div>
    <div class="main">
		<label class="switch">
		<input id="k6chb" type="checkbox" onclick="vlSwitch(6);">
		<span class="slider round"></span>
		</label>
	</div>
<div class="right"><span id="t6c">0</span> <sup>o</sup>C</div>
<div class="menu">Качество сотовой сети:</div>
    <div class="main"><span id="sQual"></span></div>
<div class="right">%</div>
<div class="menu">Температура устройства:</div>
    <div class="main"><span id="tRTC">0</span></div>
<div class="right"><sup>o</sup>C</div>
<div class="menu">Диагностические сообщения:</div>
    <div class="main"></div>
<div class="right"></div>
<textarea rows="14" cols="50" size="1" id="mainStringContent" readonly style="width:100%;padding:2px"></textarea>



      </footer>
    </section>
    <section>
      <header>
        <h1>Значения параметров VOLNA2.0</h1>
      </header>
      <footer id="current">
        <div class="wrapper"><h3>Тип системы отопления</h3></div>
        <div class="menu">
        <label class="container-r">Многоканальная с э/м клапанами
          <input type="radio" checked="checked" name="htype" id="type0" onchange="fun2();">
          <span class="checkmark-r"></span>
        </label>
        <label class="container-r">Многоканальная плавного открытия
          <input type="radio" name="htype" id="type1" onchange="fun2();">
          <span class="checkmark-r"></span>
        </label>
        <label class="container-r">Независимые контуры с фиксированной температурой
          <input type="radio" name="htype" id="type2" onchange="fun2();">
          <span class="checkmark-r"></span>
        </label>
        <label class="container-r">Независимые контуры с расписанием*
          <input type="radio" name="htype" id="type3" onchange="fun2();">
          <span class="checkmark-r"></span>
        </label>
        </div>
            <div class="main"></div>
        <div class="right"></div>
        <div class="menu">Управлять отоплением?</div>
            <div class="main">
        		<label class="switch">
        		<input id="ep2" type="checkbox"  onclick="epresp(this);">
        		<span class="slider round"></span>
        		</label>
        	</div>
        <div class="right"></div>
        <div class="menu">Управлять горячей водой?</div>
            <div class="main">
        		<label class="switch">
        		<input id="ep1" type="checkbox"  onclick="epresp(this);">
        		<span class="slider round"></span>
        		</label>
        	</div>
        <div class="right"></div>
        <div class="menu">Продолжительный ручной режим</div>
            <div class="main">
        		<label class="switch">
        		<input id="ep6" type="checkbox"  onclick="epresp(this);">
        		<span class="slider round"></span>
        		</label>
        	</div>
        <div class="right"></div>
        <div class="menu">Ежечасное обновление теплоносителя</div>
            <div class="main">
        		<label class="switch">
        		<input id="ep7" type="checkbox"  onclick="epresp(this);">
        		<span class="slider round"></span>
        		</label>
        	</div>
        <div class="right"></div>
        <div class="right_block"><button id="finalsave" class="button" onclick="saveSett();">Применить</button></div>
      </footer>
    </section>
    <section>
      <header>
        <h1>Прочее:</h1>
      </header>
      <footer id="mS">
        <div class="menu">Корректировка датчика t1:</div>
        <div class="main"><input type="number" class="rounded" step="0.1" id="ts14" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">Корректировка датчика t2:</div>
        <div class="main"><input type="number" class="rounded" step="0.1" id="ts15" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">Корректировка датчика t3:</div>
        <div class="main"><input type="number" class="rounded" step="0.1" id="ts7" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">Точность температуры отопления:</div>
        <div class="main"><input type="number" class="rounded" step="0.1" id="ep4" oninput="epresp(this);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">Точность температуры ГВС:</div>
        <div class="main"><input type="number" class="rounded" step="0.1" id="ep3" oninput="epresp(this);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">Установленная температура ГВС:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ep0" oninput="epresp(this);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">Установленная температура "Комфорта":</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ts0" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">График отопления т.1 t1:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ts1" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">График отопления т.1 t2:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ts2" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">График отопления т.1 t3:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ts3" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">График отопления т.2 t1:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ts4" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">График отопления т.2 t2:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ts5" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">График отопления т.2 t3:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ts6" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">Температура контура 1:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ts8" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">Температура контура 2:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ts9" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">Температура контура 3:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ts10" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">Температура контура 4:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ts11" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">Температура контура 5:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ts12" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">Температура контура 6:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ts13" oninput="tsrespond(this.value, this.id);"></div>
        <div class="right"><sup>o</sup>C</div>
        <div class="menu">Длительность управляющего импульса ИМ отопления:</div>
        <div class="main"><input type="number" class="rounded" step="100" id="ep9" oninput="epresp(this);"></div>
        <div class="right">мс</div>
        <div class="menu">Длительность управляющего импульса ИМ ГВС:</div>
        <div class="main"><input type="number" class="rounded" step="100" id="ep8" oninput="epresp(this);"></div>
        <div class="right">мс</div>
        <div class="menu">Вес импульса расходомера:</div>
        <div class="main"><input type="number" class="rounded" step="0.00001" id="ep5" oninput="epresp(this);"></div>
        <div class="right">м<sup>3</sup></div>
        <div class="menu">Стоимость 1 Гкал тепловой энергии:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ep11" oninput="epresp(this);"></div>
        <div class="right">тенге</div>
        <div class="menu">Удельное потребление тепловой энергии:</div>
        <div class="main"><input type="number" class="rounded" step="0.00001" id="ep12" oninput="epresp(this);"></div>
        <div class="right">Гкал/(<sup>о</sup>С*час)</div>
        <div class="menu">Базовая температура в помещении:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ep13" oninput="epresp(this);"></div>
        <div class="right"><sup>о</sup>С</div>
        <div class="menu">Удельный выброс СО2 котельной:</div>
        <div class="main"><input type="number" class="rounded" step="1" id="ep14" oninput="epresp(this);"></div>
        <div class="right">кг/Гкал</div>
        <div class="right_block"><button id="finalsave1" class="button" onclick="saveSett();">Применить</button></div>
		  </footer>
    </section>
  </section>

  <script>
  var _ = function(id) { return document.getElementById(id); };

  let rSettings={chanels:[true,false,true,false,true,false]}
    var vl = document;
    vl.onload = hel();
    var ejson;
    var connection = new WebSocket('ws://localhost:1000');
    
    connection.onerror = function (error) {
        console.log('WebSocket Error ', error);
    };
    connection.onmessage = function (e) {
      
      let checkFromServer=(JSON.parse(e.data));
      console.log(checkFromServer)
      

		//_("hmchb").checked = Number(ejson.hMode);


		_("k1chb").checked = checkFromServer.chanels[0];
		_("k2chb").checked =  checkFromServer.chanels[1];
		_("k3chb").checked =  checkFromServer.chanels[2];
		_("k4chb").checked =  checkFromServer.chanels[3];
		_("k5chb").checked =  checkFromServer.chanels[4];
		_("k6chb").checked =  checkFromServer.chanels[5];

        _("tRTC").innerHTML = checkFromServer.tRTC;
        /*
        _("t1c").innerHTML = ejson.t1c;
        _("t2c").innerHTML = ejson.t2c;
        _("t3c").innerHTML = ejson.t3c;
        _("t4c").innerHTML = ejson.t4c;
        _("t5c").innerHTML = ejson.t5c;
        _("t6c").innerHTML = ejson.t6c;*/
        var Qual = 0;
        if(Number(checkFromServer.sQual)>90){Qual = 0}else{Qual = Number(checkFromServer.sQual).toFixed(0)/32*100};
        _("sQual").innerHTML = Qual;
    };
	connection.onclose = function () {
        console.log('WebSocket connection closed');
        
    };
  
// Базовая функция при старте

    function hel() {
		var requestURL = '/settings.json';
		var request = new XMLHttpRequest();
		request.open('GET', requestURL);
		request.responseType = 'json';
		request.send();
		request.onload = function () {
			rSettings = request.response;
      fun1();
      _("ts0").value = rSettings.tempset[0];
      _("ts1").value = rSettings.tempset[1];
      _("ts2").value = rSettings.tempset[2];
      _("ts3").value = rSettings.tempset[3];
      _("ts4").value = rSettings.tempset[4];
      _("ts5").value = rSettings.tempset[5];
      _("ts6").value = rSettings.tempset[6];
      _("ts7").value = rSettings.tempset[7];
      _("ts8").value = rSettings.tempset[8];
      _("ts9").value = rSettings.tempset[9];
      _("ts10").value = rSettings.tempset[10];
      _("ts11").value = rSettings.tempset[11];
      _("ts12").value = rSettings.tempset[12];
      _("ts13").value = rSettings.tempset[13];
      _("ts14").value = rSettings.tempset[14];
      _("ts15").value = rSettings.tempset[15];
			_("ep0").value = rSettings.elParam[0];
      _("ep1").checked = rSettings.elParam[1];
      _("ep2").checked = rSettings.elParam[2];
      _("ep3").value = rSettings.elParam[3];
      _("ep4").value = rSettings.elParam[4];
      _("ep5").value = rSettings.elParam[5];
      _("ep6").checked = rSettings.elParam[6];
      _("ep7").checked = rSettings.elParam[7];
      _("ep8").value = rSettings.elParam[8];
      _("ep9").value = rSettings.elParam[9];

      _("ep11").value = rSettings.elParam[11];
      _("ep12").value = rSettings.elParam[12];
      _("ep13").value = rSettings.elParam[13];
      _("ep14").value = rSettings.elParam[14];
      }
    }

// Функция отправки команд к контроллеру
    function commandSend() {
      lT = _("commandSendText").value;
      console.log(rSettings);
      connection.send(JSON.stringify(rSettings));
    }

// Функция смены режима
   function hModeSwitch() {
	  	connection.send(JSON.stringify({mode:_('hmchb').checked}));
    }

// Функция активации канала
    function vlSwitch(nvlv) {
      console.log(nvlv-1)
      rSettings.chanels[nvlv-1]=_('k'+nvlv+'chb').checked;
    }
// Handle heating type
    function fun1() { //Set from json
    var rad=vl.getElementsByName('htype');
    var tmppar = Number(rSettings.elParam[10]);
      for (var i=0;i<rad.length; i++) {
          if(i != tmppar) {
            rad[i].checked = false;
          }
          else{
            rad[i].checked = true;
          }
      }
    }
    function fun2() { // Change in json
      console.log(rad.length)
      var rad=vl.getElementsByName('htype');
        for (var i=0;i<rad.length; i++) {
          if(rad[i].checked){
            rSettings.elParam[10]=Number(i);
            console.log("rSettings.elParam[10] = "+rSettings.elParam[10]);
          }
        }
    }

    // Handle tempset input
    function tsrespond(val, id){
      if(val.length != 0){
        rSettings.tempset[Number(id.substring(2))] = Number(val);
        console.log('rSettings.tempset[' + id.substring(2) + '] = ' + val);
      } else {console.log("==");}
    }
    function epresp(full){
        switch (full.type){
          case "number":
              if(full.value.length != 0){
          rSettings.elParam[Number(full.id.substring(2))] = Number(full.value);
          console.log('rSettings.elParam[' + full.id.substring(2) + '] = ' + full.value);
                } else {console.log("--");}
          break;
          default:
          console.log("switch failed");
          break;
          case "checkbox":
          rSettings.elParam[Number(full.id.substring(2))] = Number(full.checked);
          console.log('rSettings.elParamm[' + full.id.substring(2) + '] (chbx) = ' + Number(full.checked));
          break;
        }
    }

    // Функция применения настроек
        function saveSett() {
          var strJ = rSettings;
          console.log(strJ);
          var strD = JSON.stringify(strJ);
          var fData = new FormData();
          var myBlob = new Blob([strD], {
            type: "plain/text"
          });
          fData.append("file", myBlob, "settings.json");
          var oReq = new XMLHttpRequest();
          oReq.open("POST", "/edit.html", true);
          oReq.send(fData);
          console.log("settings updated!");
        }

  </script>
</body>

</html>
